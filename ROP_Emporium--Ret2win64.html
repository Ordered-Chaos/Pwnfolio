<!doctype html><html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Ret2win64</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="styles.css" type="text/css" />
</head>
<body><h1><b><u>Ret2win64</u></b></h1>1.  Ret2win is ROP Emporium's first challenge meant to teach the basic of return oriented Programming <br />(ROP).  ROP Emporium drops the hint in the problem description that my goal is to overwrite the <br />stack return address with the address of the ret2win function, but I will be conducting basic info <br />gathering in the name of good habits anyway. Thust, My first step was to use rabin2 to find out some <br />important basic information (Fig. 1).  This lets me see what sort of mitigations are in place and helps me get a <br />picture of what steps I can expect to take. <br /><br />    <img src="images/2-1.png" alt="images/2-1.png" />(Fig. 1)<br /><br />2.  The next step is to actually open up the file in radare2. This is easily done by simply executing <br />“r2 (path to file)” or “r2 ret2win” in this case. After opening the file, the first order of business is<br />to direct radare2 to analyze the binary. I like to use the “aaa” analysis as it is good for most things (Fig. 2).<br />You can find a list of different use syntax's for analyzing by simply typing “a ?”, and you can see<br />the help menu listing the different uses for analyzing.<br /><br />    <img src="images/2-2.png" alt="images/2-2.png" />(Fig. 2)<br /><br />3.  Once finished with the analysis, the next step I took was to use the “afl” command to analyze <br />the functions and list them. The first thing that popped out to me was there was a function <br />suspiciously named “ret2win”, so I decided to look a little deeper and see what it does.<br /><br />    <img src="images/2-3.png" alt="images/2-3.png" />(Fig. 3)<br /><br />4.  I used the seek command or “s” followed by the function name to navigate to the function's address.<br />I then used the “pdf” command to disassemble the function and print the contents. Here I can see that<br />it calls system (just as the description said), and then cat's the flag.txt file, which is exactly what I want. <br /><br />    <img src="images/2-4.png" alt="images/2-4.png" />(FIg. 4)<br /><br />5.  So now that I have the address for the magic function, I just need to find out how big the<br />stack buffer is along with where in the overflow I can overwrite RSP. To do this I wrote a <br />python script using pwntools that sends a cyclic pattern 64 characters long and opens the <br />file in pwndbg so that I can see the status of the stack when it crashes.<br /><br />    <img src="images/2-5.png" alt="images/2-5.png" />(Fig. 5)<br /><br />6.  Given the state of the stack (Fig. 6), I'm able to see that RSP gets overwritten<br />at ‘kaaa’ which starts on the 40th byte. In order to calculate this I open up an <br />interactive python shell, import pwntools and issuethe command <br />“cyclic_find('kaaa')”. Python will output where in the pattern the supplied argument<br />('kaaa') was found (Fig. 7).<br /><br />    <img src="images/2-6.png" alt="images/2-6.png" />(Fig. 6)<br />    <img src="images/2-7.png" alt="images/2-7.png" />(Fig. 7)<br /><br />7.  Now that I have the correct buffer length, I can improve my code. I'll send a cyclic pattern<br />40 bytes long, followed by the address of the ret2win function. I'll open the file in pwndbg <br />just can something goes wrong.<br /><br />    <img src="images/2-8.png" alt="images/2-8.png" />(Fig. 8)<br /><br />8.  The script worked and I got the flag (Fig. 9 &amp; 11). The output is a little verbose for me so<br />I modified my script in order to clean up the output a bit (FIg. 10). But that's all there is to it.<br /><br />    <img src="images/2-9.png" alt="images/2-9.png" />(Fig. 9)<br /><br />    <img src="images/2-10.png" alt="images/2-10.png" />(Fig. 10)<br /><br />    <img src="images/2-11.png" alt="images/2-11.png" />(Fig. 11)<br /><br /><br /><br /></body></html>